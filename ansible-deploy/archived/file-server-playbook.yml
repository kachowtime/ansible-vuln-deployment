---
# ==========================================================
# SMB Misconfiguration Deployment on Windows Server 2022
# Goals
# - Disable SMB signing
# - Create multiple weak SMB shares
# - Populate shares with junk and sensitive data
# - Enable SMB relay & lateral movement scenarios
# ==========================================================

- name: Deploy vulnerable SMB environment
  hosts: windows

  vars_files:
    - vars/main.yml

  tasks:
  # ----------------------------------------------------------
  # PLAY 1: Disable SMB signing using PowerShell
  # Primary method using supported Windows cmdlets
  # ----------------------------------------------------------
  - name: Disable SMB server signing (PowerShell)
    win_shell: |
      Set-SmbServerConfiguration -RequireSecuritySignature $false -Force

  - name: Disable SMB client signing (PowerShell)
    win_shell: |
      Set-SmbClientConfiguration -RequireSecuritySignature $false

  # ----------------------------------------------------------
  # PLAY 1: Disable SMB Signing - Allows NTLM relay attacks
  # Secondary method disabling through registry keys 
  # ----------------------------------------------------------
  - name: Disable SMB server signing
    win_regedit:
      path: HKLM:\SYSTEM\CurrentControlSet\Services\LanmanServer\Parameters
      name: RequireSecuritySignature
      data: 0
      type: dword

  - name: Disable SMB client signing
    win_regedit:
      path: HKLM:\SYSTEM\CurrentControlSet\Services\LanmanWorkstation\Parameters
      name: RequireSecuritySignature
      data: 0
      type: dword
  
  # ----------------------------------------------------------
  # PLAY 2: Restart SMB services to apply changes
  # ----------------------------------------------------------
  - name: Restart SMB services
    win_service:
      name: LanmanServer
      state: restarted

  # ----------------------------------------------------------
  # PLAY 3: Create directories for SMB shares
  # ----------------------------------------------------------
  - name: Create SMB share directories
    win_file:
      path: "{{ item.path }}"
      state: directory
    loop: "{{ shares }}"

  # ----------------------------------------------------------
  # PLAY 4: Create SMB shares with weak permissions
  # Intentional misconfiguration -- everyone has FULL access
  # ----------------------------------------------------------
  - name: Create vulnerable SMB shares
    win_share:
      name: "{{ item.name }}"
      path: "{{ item.path }}"
      description: "{{ item.description }}"
      full: Everyone
    loop: "{{ shares }}"

  # ----------------------------------------------------------
  # PLAY 5: Populate all shares with junk files
  # ----------------------------------------------------------
  - name: Add junk files to all shares
    win_copy:
      dest: "{{ item.0.path }}\\{{ item.1 }}"
      content: |
        INTERNAL FILE
        Retained for reference.
        Last modified: 2019
    loop: "{{ shares | product(junk_files) | list }}"

  # ----------------------------------------------------------
  # PLAY 6: Sensitive files exposed
  # ----------------------------------------------------------

  - name: Add IT credential notes
    win_copy:
      dest: C:\Shares\IT\admin-notes.txt
      content: |
        IT ADMIN NOTES
        ----------------
        Domain Admin: Domain_password2022!
        SQL Service: sqlsvc:SQL_Password1!
        Backup User: backup_user: Reverse2024!

  - name: Add HR employee export
    win_copy:
      dest: C:\Shares\HR\employees.txt
      content: |
        Employee Export
        ----------------
        jsmith - HR
        mjones - Finance
        awilliams - IT

  - name: Add Finance credentials
    win_copy:
      dest: C:\Shares\Finance\finance-creds.txt
      content: |
        Finance System Login
        --------------------
        finadmin:Finance2024!

  - name: Add backup documentation
    win_copy:
      dest: C:\Shares\Backups\backup-info.txt
      content: |
        Backup Server: 10.0.0.50
        Backup Share: \\backup01\backups
        Backup User: backup_user
        Backup Pass: Backup67!

